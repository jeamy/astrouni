#include "orben_dialog.h"
#include "symbol_panel.h"
#include "../database/orben_file_manager.h"
#include <wx/gbsizer.h>
#include <wx/statline.h>
#include <wx/notebook.h>

wxBEGIN_EVENT_TABLE(OrbenDialog, wxDialog)
    EVT_BUTTON(wxID_OK, OrbenDialog::OnOk)
    EVT_BUTTON(wxID_CANCEL, OrbenDialog::OnCancel)
wxEND_EVENT_TABLE()

// 1:1 Port von DlgOrbenEin aus astrouni.rc
OrbenDialog::OrbenDialog(wxWindow* parent, OrbenData& orben_data)
    : wxDialog(parent, wxID_ANY, "Orben", wxDefaultPosition, wxSize(900, 450)), 
      orben_data_(orben_data), current_typ_(0), show_houses_(false) {  // Start mit Radix

    // Setze hellen Hintergrund (Legacy-Look)
    SetBackgroundColour(*wxWHITE);

    // Lade die Astro-Schriftart
    if (!wxFont::AddPrivateFont("gui/asu_____.ttf")) {
        wxLogError("Konnte Schriftart 'gui/asu_____.ttf' nicht laden.");
    }
    wxFont astro_font(24, wxFONTFAMILY_DEFAULT, wxFONTSTYLE_NORMAL, wxFONTWEIGHT_NORMAL, false, wxT("AstroUniverse"));
    if (!astro_font.IsOk()) {
        wxLogError("Konnte Schriftart 'AstroUniverse' nicht korrekt erstellen.");
    }

    wxBoxSizer* main_sizer = new wxBoxSizer(wxVERTICAL);
    
    wxGridBagSizer* gbs = new wxGridBagSizer(2, 2);

    // Symbol-Mapping: Korrekte Unicode-Codepunkte aus der AstroUniverse-Schriftart
    // Planeten/Objekte: U+00AA bis U+00BA (17 Objekte: Sonne, Mond, Merkur, Venus, Mars, Jupiter, Saturn, Uranus, Neptun, Pluto, Mondknoten, Chiron, Lilith, Aszendent, MC, Pars Fortunae, Vesta)
    const wchar_t* planet_symbols[] = { 
        L"\u00AA", L"\u00AB", L"\u00AC", L"\u00AD", L"\u00AE", L"\u00AF", L"\u00B0", L"\u00B1", 
        L"\u00B2", L"\u00B3", L"\u00B4", L"\u00B5", L"\u00B6", L"\u00B7", L"\u00B8", L"\u00B9", L"\u00BA" 
    };
    // Aspekte: 7 Aspekte (Konjunktion, Sextil, Quadrat, Trigon, Opposition, Quincunx, Halbsextil)
    const wchar_t* aspect_symbols[] = { L"\u2018", L"\u2014", L"\u201C", L"\u201D", L"\u2019", L"\u2022", L"\u2013" };

    // Obere Leiste (Alle 17 Planeten-Symbole) - jedes Symbol in einer eigenen Spalte
    for (int i = 0; i < 17; ++i) {
        PlanetOrAspectSymbolPanel* panel = new PlanetOrAspectSymbolPanel(this, wxID_ANY, planet_symbols[i], astro_font);
        panel->SetMinSize(wxSize(45, 30));
        panel->SetBackgroundColour(*wxWHITE);
        gbs->Add(panel, wxGBPosition(0, i + 1), wxGBSpan(1, 1), wxEXPAND | wxALIGN_CENTER);
    }

    // Linke Leiste (Alle 7 Aspekt-Symbole) - jedes Symbol in einer eigenen Zeile
    for (int i = 0; i < 7; ++i) {
        PlanetOrAspectSymbolPanel* panel = new PlanetOrAspectSymbolPanel(this, wxID_ANY, aspect_symbols[i], astro_font);
        panel->SetMinSize(wxSize(30, 30));
        panel->SetBackgroundColour(*wxWHITE);
        gbs->Add(panel, wxGBPosition(i + 1, 0), wxGBSpan(1, 1), wxEXPAND | wxALIGN_CENTER);
    }

    // Gitter für die Orben-Werte - 7 Zeilen × 17 Spalten = 119 Eingabefelder (Planeten)
    text_ctrls_planet_.reserve(7 * 17);
    for (int row = 0; row < 7; ++row) {
        for (int col = 0; col < 17; ++col) {
            wxTextCtrl* textCtrl = new wxTextCtrl(this, wxID_ANY, "", wxDefaultPosition, wxSize(45, -1), wxTE_CENTER);
            gbs->Add(textCtrl, wxGBPosition(row + 1, col + 1), wxGBSpan(1, 1), wxEXPAND);
            text_ctrls_planet_.push_back(textCtrl);
        }
    }
    

    // Rechte Spalte
    wxBoxSizer* right_column = new wxBoxSizer(wxVERTICAL);
    right_column->Add(new wxStaticText(this, wxID_ANY, "Radix"), 0, wxALL, 5);
    right_column->Add(new wxStaticLine(this, wxID_ANY), 0, wxEXPAND | wxLEFT | wxRIGHT, 5);
    wxString typ_choices[] = { "Radix", "Transit", "Synastrie" };
    wxRadioBox* typ_radio = new wxRadioBox(this, wxID_ANY, "Orben für:", wxDefaultPosition, wxDefaultSize, 3, typ_choices, 1, wxRA_SPECIFY_COLS);
    typ_radio->SetSelection(current_typ_);
    typ_radio->Bind(wxEVT_RADIOBOX, [this, typ_radio](wxCommandEvent&) {
        // Speichere aktuelle Werte
        SaveOrbenValues();
        // Wechsle Typ
        current_typ_ = typ_radio->GetSelection();
        // Lade neue Werte
        LoadOrbenValues();
    });
    right_column->Add(typ_radio, 0, wxEXPAND | wxALL, 5);
    
    // Checkbox für Häuser/Planeten
    wxCheckBox* haus_check = new wxCheckBox(this, wxID_ANY, "Häuser");
    haus_check->SetValue(show_houses_);
    haus_check->Bind(wxEVT_CHECKBOX, [this, haus_check](wxCommandEvent&) {
        // Speichere aktuelle Werte
        SaveOrbenValues();
        // Wechsle Anzeige
        show_houses_ = haus_check->GetValue();
        // Lade neue Werte
        LoadOrbenValues();
        // TODO: Update Symbol-Leiste
    });
    right_column->Add(haus_check, 0, wxALIGN_LEFT | wxALL, 5);
    
    right_column->Add(new wxCheckBox(this, wxID_ANY, "Zombie"), 0, wxALIGN_LEFT | wxALL, 5);
    gbs->Add(right_column, wxGBPosition(0, 18), wxGBSpan(8, 1), wxEXPAND | wxLEFT | wxRIGHT, 10);

    main_sizer->Add(gbs, 1, wxEXPAND | wxALL, 10);

    // Buttons
    wxBoxSizer* button_sizer = new wxBoxSizer(wxHORIZONTAL);
    button_sizer->Add(new wxButton(this, wxID_OK, "Ok"), 0, wxALL, 5);
    
    wxButton* default_btn = new wxButton(this, wxID_ANY, "Default");
    default_btn->Bind(wxEVT_BUTTON, &OrbenDialog::OnDefault, this);
    button_sizer->Add(default_btn, 0, wxALL, 5);
    
    button_sizer->Add(new wxButton(this, wxID_CANCEL, "Abbruch"), 0, wxALL, 5);
    button_sizer->AddStretchSpacer();
    button_sizer->Add(new wxButton(this, wxID_HELP, "Hilfe"), 0, wxALL, 5);
    
    wxButton* zap_btn = new wxButton(this, wxID_ANY, "ZAP!");
    zap_btn->Bind(wxEVT_BUTTON, &OrbenDialog::OnZap, this);
    button_sizer->Add(zap_btn, 0, wxALL, 5);
    
    main_sizer->Add(button_sizer, 0, wxEXPAND | wxLEFT | wxRIGHT | wxBOTTOM, 10);

    SetSizerAndFit(main_sizer);
    Centre();
    
    // Lade die aktuellen Orben-Werte in die TextCtrls
    LoadOrbenValues();
}

void OrbenDialog::LoadOrbenValues() {
    if (show_houses_) {
        // Lade Häuser-Orben
        float (*data)[7] = nullptr;
        switch (current_typ_) {
            case 0: data = orben_data_.radix_haus; break;
            case 1: data = orben_data_.transit_haus; break;
            case 2: data = orben_data_.synastrie_haus; break;
        }
        
        if (!data) return;
        
        // Verwende die ersten 12 Spalten der Planeten-TextCtrls für Häuser
        // Verstecke Spalten 13-17
        for (int row = 0; row < 7; ++row) {
            for (int col = 0; col < 17; ++col) {
                int index = row * 17 + col;
                if (col < 12) {
                    // Zeige und fülle die ersten 12 Spalten mit Häuser-Daten
                    text_ctrls_planet_[index]->Show();
                    text_ctrls_planet_[index]->SetValue(wxString::Format("%.1f", data[col][row]));
                } else {
                    // Verstecke Spalten 13-17
                    text_ctrls_planet_[index]->Hide();
                }
            }
        }
    } else {
        // Lade Planeten-Orben
        float (*data)[7] = nullptr;
        switch (current_typ_) {
            case 0: data = orben_data_.radix_planet; break;
            case 1: data = orben_data_.transit_planet; break;
            case 2: data = orben_data_.synastrie_planet; break;
        }
        
        if (!data) return;
        
        // Zeige alle 17 Spalten und fülle mit Planeten-Daten
        for (int row = 0; row < 7; ++row) {
            for (int col = 0; col < 17; ++col) {
                int index = row * 17 + col;
                text_ctrls_planet_[index]->Show();
                text_ctrls_planet_[index]->SetValue(wxString::Format("%.1f", data[col][row]));
            }
        }
    }
    Layout();
}

void OrbenDialog::SaveOrbenValues() {
    if (show_houses_) {
        // Speichere Häuser-Orben (aus den ersten 12 Spalten der Planeten-TextCtrls)
        float (*data)[7] = nullptr;
        switch (current_typ_) {
            case 0: data = orben_data_.radix_haus; break;
            case 1: data = orben_data_.transit_haus; break;
            case 2: data = orben_data_.synastrie_haus; break;
        }
        
        if (!data) return;
        
        // Lese Werte aus den ersten 12 Spalten
        for (int row = 0; row < 7; ++row) {
            for (int col = 0; col < 12; ++col) {
                int index = row * 17 + col;
                double value;
                if (text_ctrls_planet_[index]->GetValue().ToDouble(&value)) {
                    data[col][row] = static_cast<float>(value);
                }
            }
        }
    } else {
        // Speichere Planeten-Orben (alle 17 Spalten)
        float (*data)[7] = nullptr;
        switch (current_typ_) {
            case 0: data = orben_data_.radix_planet; break;
            case 1: data = orben_data_.transit_planet; break;
            case 2: data = orben_data_.synastrie_planet; break;
        }
        
        if (!data) return;
        
        // Lese Werte aus allen 17 Spalten
        for (int row = 0; row < 7; ++row) {
            for (int col = 0; col < 17; ++col) {
                int index = row * 17 + col;
                double value;
                if (text_ctrls_planet_[index]->GetValue().ToDouble(&value)) {
                    data[col][row] = static_cast<float>(value);
                }
            }
        }
    }
}

void OrbenDialog::LoadDefaultValues() {
    // Lade Default-Werte aus default.dat
    OrbenFileManager file_mgr;
    file_mgr.LoadFromDefaultFile(orben_data_);
    LoadOrbenValues();
}

void OrbenDialog::OnOk(wxCommandEvent& event) {
    SaveOrbenValues();
    
    // Speichere in astroini.dat (vorerst nur im Speicher)
    OrbenFileManager file_mgr;
    file_mgr.SaveToIniFile(orben_data_);
    
    EndModal(wxID_OK);
}

void OrbenDialog::OnDefault(wxCommandEvent& event) {
    LoadDefaultValues();
}

void OrbenDialog::OnZap(wxCommandEvent& event) {
    // ZAP lädt die absoluten Default-Werte aus default.dat
    OrbenFileManager file_mgr;
    file_mgr.LoadFromDefaultFile(orben_data_);
    LoadOrbenValues();
}

void OrbenDialog::OnCancel(wxCommandEvent& event) {
    // Beim Abbruch: Lade die ursprünglichen Werte neu (verwerfe Änderungen)
    LoadOrbenValues();
    EndModal(wxID_CANCEL);
}
